#!/usr/bin/env node
// {{generated_message}}

const fs = require('fs')
const path = require('path')
const config = getRenderedConfig()
const ghooks = getGhooksEntryPoint()

if (checkForGHooks(ghooks)) {
  require(ghooks)(__dirname, __filename)
}

function getRenderedConfig() {
  // ghooks' actual config gets rendered here
  // it gets substituted on ghooks' setup
  // {{generated_config_start}}
  return global.__testonly_ghooksConfig__ || {}
  // {{generated_config_end}}
}

function getGhooksEntryPoint() {
  const worktree = getWorkTree()
  if (worktree) {
    return path.resolve(__dirname, '../', worktree, 'node_modules', 'ghooks')
  }
  return 'ghooks'
}

function checkForGHooks(ghooksPath) {
  try {
    require(ghooksPath)
  } catch (e) {
    warnAboutGHooks()
    return false
  }
  return true
}

function getWorkTree() {
  try {
    return getWorkTreeFromConfig(getConfigFileContent())
  } catch (e) {
    return null
  }
}

function getConfigFileContent() {
  const configFile = path.resolve(__dirname, '../config')
  const fileStat = fs.statSync(configFile)
  if (fileStat && fileStat.isFile()) {
    return fs.readFileSync(configFile, 'utf8')
  }
  return ''
}

function getWorkTreeFromConfig(configFileContent) {
  const worktreeRegEx = /\[core\][^]{0,}worktree = ([^\n]{1,})[^]{0,}/
  return worktreeRegEx.test(configFileContent) ? configFileContent.replace(worktreeRegEx, '$1') : ''
}

function warnAboutGHooks() {
  console.warn( // eslint-disable-line no-console
    'ghooks not found!\n' +
    'Make sure you have it installed on your "node_modules".'
  )
  if (config.exitWithError) {
    console.warn('Aborting operation.') // eslint-disable-line no-console
    process.exit(1)
  }
  console.warn('Skipping git hooks.') // eslint-disable-line no-console
}
